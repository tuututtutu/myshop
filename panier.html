<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Panier â€“ MyShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,sans-serif}
    body{background:radial-gradient(circle at top,#0f172a,#020617);color:#e5e7eb;min-height:100vh}
    header{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:22px 60px;background:rgba(2,6,23,.85);backdrop-filter:blur(14px);border-bottom:1px solid rgba(255,255,255,.05)}
    header h1{font-size:2rem;color:#38bdf8}
    nav a,nav span{margin-left:28px;text-decoration:none;color:#cbd5f5}
    nav a:hover{color:#38bdf8}
    .container{max-width:900px;margin:70px auto;padding:0 25px}
    h2{text-align:center;font-size:2.4rem;margin-bottom:45px}
    .item{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,#0f172a,#020617);border-radius:18px;padding:22px 26px;margin-bottom:20px;box-shadow:0 20px 50px rgba(56,189,248,.18)}
    .left{display:flex;align-items:center;gap:20px}
    .left img{width:80px;border-radius:12px}
    .item-price{color:#38bdf8;font-weight:bold}
    .remove{background:linear-gradient(135deg,#ef4444,#dc2626);border:none;color:white;padding:10px 18px;border-radius:12px;cursor:pointer}
    .total{text-align:center;font-size:1.8rem;margin-top:35px;color:#38bdf8}
    .pay{display:block;margin:30px auto 0;padding:16px 42px;font-size:1.1rem;border-radius:16px;border:none;background:linear-gradient(135deg,#38bdf8,#0ea5e9);color:#020617;font-weight:700;cursor:pointer}
    .empty{text-align:center;opacity:.7;margin-top:40px}
  </style>
</head>

<body>

<header>
  <h1>MyShop</h1>
  <nav>
    <a href="index.html">Accueil</a>
    <a href="produit.html">Produits</a>
    <a href="connexion.html" id="loginLink">Connexion</a>
    <a href="panier.html">Panier</a>
    <span id="username"></span>
    <a href="#" id="logout" style="display:none;">DÃ©connexion</a>
  </nav>
</header>

<div class="container">
  <h2>Votre Panier</h2>
  <div id="cart"></div>
  <div class="total" id="total"></div>
  <button class="pay" id="checkout">Paiement sÃ©curisÃ©</button>
</div>

<!-- ðŸ”’ PROTECTION PANIER -->
<script>
if (localStorage.getItem("loggedIn") !== "true") {
  alert("Vous devez Ãªtre connectÃ© pour accÃ©der au panier ðŸ”’");
  window.location.href = "connexion.html";
}
</script>

<!-- ðŸ›’ PANIER PAR UTILISATEUR -->
<script>
const user = JSON.parse(localStorage.getItem("user"));
const cartKey = "cart_" + user.email;
let cart = JSON.parse(localStorage.getItem(cartKey)) || [];

const cartDiv = document.getElementById("cart");
const totalDiv = document.getElementById("total");

function renderCart() {
  cartDiv.innerHTML = "";
  let total = 0;

  if (!cart.length) {
    cartDiv.innerHTML = "<p class='empty'>Votre panier est vide ðŸ›’</p>";
    totalDiv.textContent = "";
    return;
  }

  cart.forEach((item, index) => {
    total += item.price;

    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
      <div class="left">
        <img src="images/${item.product}-${item.color}.png" alt="">
        <div>
          <strong>${item.name}</strong><br>
          <small>Couleur : ${item.color}</small>
          ${item.size ? `<br><small>Taille : ${item.size}</small>` : ""}
        </div>
      </div>
      <div>
        <div class="item-price">${item.price} â‚¬</div>
        <button class="remove">Supprimer</button>
      </div>
    `;

    div.querySelector(".remove").onclick = () => {
      cart.splice(index, 1);
      localStorage.setItem(cartKey, JSON.stringify(cart));
      renderCart();
    };

    cartDiv.appendChild(div);
  });

  totalDiv.textContent = "Total : " + total + " â‚¬";
}

renderCart();
</script>

<!-- ðŸ‘¤ NAVBAR CONNEXION / DÃ‰CONNEXION -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const loginLink = document.getElementById("loginLink");
  const logoutBtn = document.getElementById("logout");
  const usernameSpan = document.getElementById("username");

  const loggedIn = localStorage.getItem("loggedIn");
  const user = JSON.parse(localStorage.getItem("user"));

  if (loggedIn === "true" && user && user.name) {
    loginLink.style.display = "none";
    logoutBtn.style.display = "inline-block";
    usernameSpan.style.display = "inline-block";
    usernameSpan.textContent = "ðŸ‘¤ " + user.name;
  } else {
    loginLink.style.display = "inline-block";
    logoutBtn.style.display = "none";
    usernameSpan.style.display = "none";
  }

  logoutBtn.addEventListener("click", e => {
    e.preventDefault();
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("user");
    window.location.href = "connexion.html";
  });
});
</script>

<!-- ðŸ’³ STRIPE -->
<script>
const stripe = Stripe("pk_test_51POF9cFyvybDzHL8CHWecWKRmap2ZATmiZvldg1fUP0AXjlA8oYg9FlPIxlwn67OHROHGmSk7woj52fWth6yfmcW00KXwtvgyr");

document.getElementById("checkout").addEventListener("click", async () => {
  if (!cart.length) {
    alert("Votre panier est vide");
    return;
  }

  const res = await fetch("create-checkout-session.php", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(cart)
  });

  const session = await res.json();
  stripe.redirectToCheckout({ sessionId: session.id });
});
</script>

</body>
</html>
